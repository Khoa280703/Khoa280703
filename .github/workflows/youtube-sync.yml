name: Sync YouTube Videos

on:
  schedule:
    - cron: "0 12 * * *"  # Daily at 12:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch & Parse YouTube RSS
        env:
          CHANNEL_ID: ${{ secrets.YOUTUBE_CHANNEL_ID }}
        run: |
          python3 << 'PYEOF'
          import urllib.request
          import xml.etree.ElementTree as ET
          import re

          # Get channel ID from secret or environment
          channel_id = env.get('CHANNEL_ID', '')
          if not channel_id:
              print("No CHANNEL_ID found - skipping sync")
              exit(0)

          # Fetch RSS feed
          rss_url = f"https://www.youtube.com/feeds/videos.xml?channel_id={channel_id}"
          try:
              with urllib.request.urlopen(rss_url) as response:
                  xml_data = response.read()
          except:
              print(f"Failed to fetch RSS from {rss_url}")
              exit(0)

          # Parse XML
          root = ET.fromstring(xml_data)
          ns = {'atom': 'http://www.w3.org/2005/Atom',
                'yt': 'http://www.youtube.com/xml/schemas/2015',
                'media': 'http://search.yahoo.com/mrss/'}

          # Extract 3 most recent videos
          videos = []
          for entry in root.findall('atom:entry', ns)[:3]:
              video_id = entry.find('yt:videoId', ns).text
              title = entry.find('atom:title', ns).text
              link = entry.find('atom:link', ns).attrib['href']
              published = entry.find('atom:published', ns).text[:10]
              thumbnail = f"https://img.youtube.com/vi/{video_id}/maxresdefault.jpg"

              videos.append({'title': title, 'thumbnail': thumbnail,
                           'url': link, 'published': published})

          # Generate markdown
          md = "<!-- START YOUTUBE -->\n\n"
          md += "<div align='center'>\n\n"
          md += "## ðŸŽ¬ Latest Videos\n\n"

          for v in videos:
              md += f"<a href='{v['url']}' target='_blank'>\n"
              md += f"  <img src='{v['thumbnail']}' alt='{v['title']}' "
              md += f"width='320' style='border-radius:10px; margin:10px;' />\n"
              md += f"</a>\n\n"
              md += f"**[{v['title']}]({v['url']})**\n\n"
              md += f"*{v['published']}*\n\n---\n\n"

          md += "</div>\n\n<!-- END YOUTUBE -->\n"

          with open('youtube-section.md', 'w') as f:
              f.write(md)

          print(f"âœ… Synced {len(videos)} videos")
          PYEOF

      - name: Update README
        run: |
          # Remove old section
          sed -i '/<!-- START YOUTUBE -->/,/<\/div><!-- END YOUTUBE -->/d' README.md
          # Insert new section at line 259 (after Wave Separator 3)
          sed -i '259r youtube-section.md' README.md

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md youtube-section.md
          git diff --quiet && git diff --staged --quiet || \
          (git commit -m "feat: sync YouTube videos [skip ci]" && git push)
